<div class="card">
    <!-- Toolbar -->
    <p-toolbar styleClass="mb-4">
        <ng-template pTemplate="left">
            <p-button label="Back to Dashboard" icon="pi pi-arrow-left" styleClass="p-button-secondary mr-2"
                     (onClick)="goBackToDashboard()"></p-button>
        </ng-template>

        <ng-template pTemplate="right">
            <p-button label="Export" icon="pi pi-download" styleClass="p-button-help mr-2"
                     (onClick)="exportUsers()"></p-button>
            <p-button label="New User" icon="pi pi-plus" styleClass="p-button-success mr-2"
                     (onClick)="openNewUserDialog()"></p-button>
            <p-inputText placeholder="Search users..." [(ngModel)]="searchValue"
                        (input)="onSearch($event)" styleClass="ml-2"></p-inputText>
        </ng-template>
    </p-toolbar>

    <!-- Users Table -->
    <p-table #dt [value]="users" [paginator]="true" [rows]="rows" [totalRecords]="totalRecords"
             [rowsPerPageOptions]="[5,10,25,50]" [loading]="loading" [lazy]="true"
             [(selection)]="selectedUsers" [rowHover]="true" dataKey="id"
             currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
             [showCurrentPageReport]="true" responsiveLayout="scroll"
             (onPage)="onPageChange($event)" [first]="first">

        <ng-template pTemplate="caption">
            <div class="flex align-items-center justify-content-between">
                <h5 class="m-0">System Users</h5>
                <span class="p-input-icon-left">
                    <i class="pi pi-search"></i>
                    <input pInputText type="text" [(ngModel)]="globalFilterValue"
                           (input)="onGlobalFilter(dt, $event)"
                           placeholder="Search all columns..." />
                </span>
            </div>
        </ng-template>

        <ng-template pTemplate="header">
            <tr>
                <th style="width: 3rem">
                    <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                </th>
                <th pSortableColumn="name" style="min-width:15rem">
                    Name <p-sortIcon field="name"></p-sortIcon>
                </th>
                <th pSortableColumn="email" style="min-width:20rem">
                    Email <p-sortIcon field="email"></p-sortIcon>
                </th>
                <th pSortableColumn="role" style="min-width:12rem">
                    Role <p-sortIcon field="role"></p-sortIcon>
                </th>
                <th pSortableColumn="status" style="min-width:10rem">
                    Status <p-sortIcon field="status"></p-sortIcon>
                </th>
                <th pSortableColumn="lastLogin" style="min-width:15rem">
                    Last Login <p-sortIcon field="lastLogin"></p-sortIcon>
                </th>
                <th pSortableColumn="createdAt" style="min-width:15rem">
                    Created <p-sortIcon field="createdAt"></p-sortIcon>
                </th>
                <th style="min-width:12rem">Actions</th>
            </tr>
            <tr>
                <th></th>
                <th>
                    <p-columnFilter type="text" field="name" placeholder="Search by name"></p-columnFilter>
                </th>
                <th>
                    <p-columnFilter type="text" field="email" placeholder="Search by email"></p-columnFilter>
                </th>
                <th>
                    <p-columnFilter field="role" matchMode="equals" [showMenu]="false">
                        <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                            <p-dropdown [ngModel]="selectedRole" [options]="roles"
                                       (onChange)="onRoleFilter($event)" placeholder="Any">
                            </p-dropdown>
                        </ng-template>
                    </p-columnFilter>
                </th>
                <th>
                    <p-columnFilter field="status" matchMode="equals" [showMenu]="false">
                        <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                            <p-dropdown [ngModel]="selectedStatus" [options]="statuses"
                                       (onChange)="onStatusFilter($event)" placeholder="Any">
                            </p-dropdown>
                        </ng-template>
                    </p-columnFilter>
                </th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-user>
            <tr>
                <td>
                    <p-tableCheckbox [value]="user"></p-tableCheckbox>
                </td>
                <td>
                    <div class="flex align-items-center">
                        <div class="user-avatar-wrapper mr-2">
                            <p-avatar *ngIf="!user.profileImageUrl"
                                     [label]="user.name.charAt(0)" size="large"
                                     [style]="{'background-color': getAvatarColor(user.name), 'color': '#ffffff'}"></p-avatar>
                            <p-avatar *ngIf="user.profileImageUrl"
                                     [image]="user.profileImageUrl" size="large"
                                     shape="circle"></p-avatar>
                        </div>
                        <div>
                            <div class="font-medium">{{user.name}}</div>
                            <div class="text-sm text-500">{{user.username}}</div>
                        </div>
                    </div>
                </td>
                <td>{{user.email}}</td>
                <td>
                    <p-tag [value]="user.role" [severity]="getRoleSeverity(user.role)"></p-tag>
                </td>
                <td>
                    <p-tag [value]="user.status" [severity]="getStatusSeverity(user.status)"></p-tag>
                </td>
                <td>
                    <span *ngIf="user.lastLogin; else neverLoggedIn">
                        {{user.lastLogin | date:'medium'}}
                    </span>
                    <ng-template #neverLoggedIn>
                        <span class="text-500">Never</span>
                    </ng-template>
                </td>
                <td>{{user.createdAt | date:'medium'}}</td>
                <td>
                    <div class="flex">
                        <p-button icon="pi pi-pencil" styleClass="p-button-rounded p-button-success mr-2"
                                 pTooltip="Edit" tooltipPosition="top" (onClick)="editUser(user)"></p-button>
                        <p-button icon="pi pi-lock" styleClass="p-button-rounded p-button-warning mr-2"
                                 pTooltip="Reset Password" tooltipPosition="top" (onClick)="resetPassword(user)"></p-button>
                        <p-button icon="pi pi-ban" styleClass="p-button-rounded p-button-danger mr-2"
                                 pTooltip="Deactivate" tooltipPosition="top" (onClick)="confirmDeleteUser(user)"
                                 [disabled]="user.status === 'Inactive'"></p-button>
                        <p-button icon="pi pi-eye" styleClass="p-button-rounded p-button-info"
                                 pTooltip="View Details" tooltipPosition="top" (onClick)="viewUserDetails(user)"></p-button>
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="text-500">No users found.</div>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Bulk Actions -->
    <div class="mt-3" *ngIf="selectedUsers && selectedUsers.length > 0">
        <p-toolbar>
            <ng-template pTemplate="left">
                <span class="mr-2">{{selectedUsers.length}} user(s) selected</span>
            </ng-template>
            <ng-template pTemplate="right">
                <p-button label="Bulk Deactivate" icon="pi pi-ban" styleClass="p-button-danger mr-2"
                         (onClick)="bulkDeactivate()"></p-button>
                <p-button label="Bulk Activate" icon="pi pi-check" styleClass="p-button-success mr-2"
                         (onClick)="bulkActivate()"></p-button>
                <p-button label="Clear Selection" icon="pi pi-times" styleClass="p-button-secondary"
                         (onClick)="clearSelection()"></p-button>
            </ng-template>
        </p-toolbar>
    </div>
</div>

<!-- New/Edit User Dialog -->
<p-dialog [(visible)]="userDialog" [style]="{width: '900px', height: '700px'}"
          [header]="editMode ? 'Edit User' : 'Create New User'"
          [modal]="true" styleClass="user-dialog" [closable]="true">

    <ng-template pTemplate="content">
        <form [formGroup]="userForm" (ngSubmit)="saveUser()">
            <div class="grid">
                <!-- Profile Image Section -->
                <div class="col-12 mb-4">
                    <div class="profile-image-section">
                        <div class="profile-image-container">
                            <div class="profile-image-wrapper">
                                <div class="profile-image" *ngIf="getAvatarType(selectedUser) === 'image'">
                                    <img [src]="getAvatarDisplay(selectedUser)" alt="Profile" class="profile-img">
                                </div>
                                <div class="profile-image" *ngIf="getAvatarType(selectedUser) === 'text'"
                                     [style.background]="selectedUser ? getAvatarColor(selectedUser.name) : '#6c757d'">
                                    <span class="profile-text">{{getAvatarDisplay(selectedUser)}}</span>
                                </div>

                                <div class="image-overlay">
                                    <label for="profileImage" class="image-upload-btn">
                                        <i class="pi pi-camera"></i>
                                        <span>Change Photo</span>
                                    </label>
                                    <input type="file" id="profileImage" accept="image/*"
                                           (change)="onFileSelected($event)" style="display: none;">
                                </div>

                                <button type="button" class="remove-image-btn"
                                        *ngIf="imagePreview || (selectedUser && selectedUser.profileImageUrl)"
                                        (click)="removeImage()">
                                    <i class="pi pi-times"></i>
                                </button>
                            </div>

                            <div class="upload-status" *ngIf="isUploadingImage">
                                <i class="pi pi-spin pi-spinner"></i>
                                <span>Uploading...</span>
                            </div>
                        </div>

                        <div class="profile-info">
                            <h4 class="profile-title">{{editMode ? 'Update Profile' : 'Add Profile Picture'}}</h4>
                            <p class="profile-subtitle">Upload a professional photo for better identification</p>
                        </div>
                    </div>
                </div>

                <!-- Form Fields -->
                <div class="col-12">
                    <div class="form-grid">
                        <div class="form-row">
                            <div class="form-field">
                                <label htmlFor="firstName" class="form-label">First Name *</label>
                                <input id="firstName" type="text" pInputText formControlName="firstName"
                                       [class.ng-invalid]="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched"
                                       placeholder="Enter first name">
                                <small class="p-error" *ngIf="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched">
                                    First name is required
                                </small>
                            </div>

                            <div class="form-field">
                                <label htmlFor="lastName" class="form-label">Last Name *</label>
                                <input id="lastName" type="text" pInputText formControlName="lastName"
                                       [class.ng-invalid]="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched"
                                       placeholder="Enter last name">
                                <small class="p-error" *ngIf="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched">
                                    Last name is required
                                </small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-field">
                                <label htmlFor="username" class="form-label">Username *</label>
                                <input id="username" type="text" pInputText formControlName="username"
                                       [class.ng-invalid]="userForm.get('username')?.invalid && userForm.get('username')?.touched"
                                       placeholder="Enter username">
                                <small class="p-error" *ngIf="userForm.get('username')?.invalid && userForm.get('username')?.touched">
                                    <span *ngIf="userForm.get('username')?.errors?.['required']">Username is required</span>
                                    <span *ngIf="userForm.get('username')?.errors?.['usernameTaken']">Username is already taken</span>
                                </small>
                            </div>

                            <div class="form-field">
                                <label htmlFor="email" class="form-label">Email *</label>
                                <input id="email" type="email" pInputText formControlName="email"
                                       [class.ng-invalid]="userForm.get('email')?.invalid && userForm.get('email')?.touched"
                                       placeholder="Enter email address">
                                <small class="p-error" *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
                                    <span *ngIf="userForm.get('email')?.errors?.['required']">Email is required</span>
                                    <span *ngIf="userForm.get('email')?.errors?.['email']">Valid email is required</span>
                                    <span *ngIf="userForm.get('email')?.errors?.['emailTaken']">Email is already registered</span>
                                </small>
                            </div>
                        </div>

                        <div class="form-row" *ngIf="!editMode">
                            <div class="form-field full-width">
                                <label htmlFor="password" class="form-label">Password *</label>
                                <p-password id="password" formControlName="password" [toggleMask]="true"
                                           styleClass="w-full" [feedback]="true"
                                           [class.ng-invalid]="userForm.get('password')?.invalid && userForm.get('password')?.touched"
                                           placeholder="Enter password">
                                </p-password>
                                <small class="p-error" *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched">
                                    Password must be at least 8 characters
                                </small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-field">
                                <label htmlFor="role" class="form-label">Role *</label>
                                <p-dropdown id="role" formControlName="role" [options]="roles"
                                           optionLabel="label" optionValue="value" placeholder="Select a role"
                                           [class.ng-invalid]="userForm.get('role')?.invalid && userForm.get('role')?.touched"
                                           styleClass="w-full">
                                </p-dropdown>
                                <small class="p-error" *ngIf="userForm.get('role')?.invalid && userForm.get('role')?.touched">
                                    Role is required
                                </small>
                            </div>

                            <div class="form-field">
                                <label htmlFor="department" class="form-label">Department</label>
                                <p-dropdown id="department" formControlName="department" [options]="departments"
                                           optionLabel="label" optionValue="value" placeholder="Select department"
                                           styleClass="w-full" [showClear]="true">
                                </p-dropdown>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-field">
                                <label htmlFor="phone" class="form-label">Phone</label>
                                <input id="phone" type="tel" pInputText formControlName="phone"
                                       placeholder="Enter phone number">
                            </div>

                            <div class="form-field">
                                <label class="form-label">Account Status</label>
                                <div class="status-toggle" (click)="toggleAccountStatus()">
                                    <p-checkbox formControlName="isActive" inputId="isActive" styleClass="mr-2"></p-checkbox>
                                    <label htmlFor="isActive" class="status-label">
                                        {{userForm.get('isActive')?.value ? 'Active Account' : 'Inactive Account'}}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </ng-template>

    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" styleClass="p-button-text"
                 (onClick)="hideDialog()"></p-button>
        <p-button label="Save" icon="pi pi-check" styleClass="p-button-text"
                 [disabled]="!userForm.valid" (onClick)="saveUser()"></p-button>
    </ng-template>
</p-dialog>

<!-- Delete Confirmation Dialog -->
<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

<!-- User Details Dialog -->
<p-dialog [(visible)]="userDetailsDialog" [style]="{width: '700px'}" header="User Details"
          [modal]="true" styleClass="p-fluid">

    <ng-template pTemplate="content" *ngIf="selectedUser">
        <div class="grid">
            <div class="col-12 md:col-4 text-center">
                <div class="user-detail-avatar">
                    <p-avatar *ngIf="!selectedUser.profileImageUrl"
                             [label]="selectedUser.name.charAt(0)" size="xlarge"
                             [style]="{'background-color': getAvatarColor(selectedUser.name), 'color': '#ffffff'}"></p-avatar>
                    <p-avatar *ngIf="selectedUser.profileImageUrl"
                             [image]="selectedUser.profileImageUrl" size="xlarge"
                             shape="circle"></p-avatar>
                </div>
                <h5 class="mt-3">{{selectedUser.name}}</h5>
                <p-tag [value]="selectedUser.role" [severity]="getRoleSeverity(selectedUser.role)"></p-tag>
            </div>

            <div class="col-12 md:col-8">
                <div class="grid">
                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label class="font-medium">Username:</label>
                            <div>{{selectedUser.username}}</div>
                        </div>
                    </div>
                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label class="font-medium">Email:</label>
                            <div>{{selectedUser.email}}</div>
                        </div>
                    </div>
                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label class="font-medium">Phone:</label>
                            <div>{{selectedUser.phone || 'Not provided'}}</div>
                        </div>
                    </div>
                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label class="font-medium">Department:</label>
                            <div>{{selectedUser.department || 'Not assigned'}}</div>
                        </div>
                    </div>
                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label class="font-medium">Status:</label>
                            <div>
                                <p-tag [value]="selectedUser.status" [severity]="getStatusSeverity(selectedUser.status)"></p-tag>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label class="font-medium">Last Login:</label>
                            <div>
                                <span *ngIf="selectedUser.lastLogin; else neverLoggedInDetail">
                                    {{selectedUser.lastLogin | date:'medium'}}
                                </span>
                                <ng-template #neverLoggedInDetail>
                                    <span class="text-500">Never logged in</span>
                                </ng-template>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label class="font-medium">Created:</label>
                            <div>{{selectedUser.createdAt | date:'medium'}}</div>
                        </div>
                    </div>
                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label class="font-medium">Last Updated:</label>
                            <div>{{selectedUser.updatedAt | date:'medium'}}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <p-button label="Close" icon="pi pi-times" styleClass="p-button-text"
                 (onClick)="userDetailsDialog = false"></p-button>
        <p-button label="Edit" icon="pi pi-pencil" styleClass="p-button-primary"
                 (onClick)="selectedUser && editUser(selectedUser); userDetailsDialog = false"></p-button>
    </ng-template>
</p-dialog>

<p-toast></p-toast>
